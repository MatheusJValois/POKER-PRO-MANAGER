<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PokerPro Manager v7 (PKO Edition)</title>
    
    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Alpine.js -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>

    <!-- Fontes e Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Outfit', 'sans-serif'], 
                        mono: ['JetBrains Mono', 'monospace'] 
                    },
                    colors: { 
                        dark: { 950: '#020617', 900: '#0f172a', 800: '#1e293b' },
                        primary: { 500: '#3b82f6', 600: '#2563eb' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #020617; 
            color: #e2e8f0; 
            background-image: 
                radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.15) 0px, transparent 50%), 
                radial-gradient(at 100% 0%, rgba(16, 185, 129, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
        }
        
        /* Glassmorphism Cards */
        .glass-card { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }
        
        .glass-input { 
            background: rgba(15, 23, 42, 0.6); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            color: white; 
            transition: all 0.3s ease; 
        }
        .glass-input:focus { 
            outline: none; 
            border-color: #3b82f6; 
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); 
            background: rgba(15, 23, 42, 0.9);
        }
        
        .tag-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
        }
        .tag-item:hover { background: rgba(255,255,255,0.1); }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Níveis Styles */
        .level-gradient-1 { background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(153, 27, 27, 0.05)); border-left: 4px solid #ef4444; }
        .level-gradient-2 { background: linear-gradient(135deg, rgba(249, 115, 22, 0.1), rgba(154, 52, 18, 0.05)); border-left: 4px solid #f97316; }
        .level-gradient-3 { background: linear-gradient(135deg, rgba(234, 179, 8, 0.1), rgba(161, 98, 7, 0.05)); border-left: 4px solid #eab308; }
        .level-gradient-4 { background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(6, 95, 70, 0.05)); border-left: 4px solid #10b981; }
        .level-gradient-5 { background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(21, 94, 117, 0.05)); border-left: 4px solid #06b6d4; }
        .level-gradient-6 { background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(30, 58, 138, 0.05)); border-left: 4px solid #3b82f6; }
        .level-gradient-7 { background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(107, 33, 168, 0.05)); border-left: 4px solid #a855f7; }

        [x-cloak] { display: none !important; }
        
        .stop-loss-alert { animation: pulse-red 2s infinite; border: 2px solid #ef4444; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>

    <!-- LÓGICA -->
    <script>
        const LEVELS_CFG = [
            { id: 1, name: "Base / Reconstrução", min: -99999, max: 600, color: "text-red-400", bg: "bg-red-500", border: "level-gradient-1", icon: "fa-shield-halved", abiSupport: "$1.00 – $2.00", abiCore: "$2.50 – $3.00", abiShot: "$3.20", pSupport: "40%", pCore: "50%", pShot: "10%", dist: "40% Suporte / 50% Core / 10% Shot", rules: "Foco em recuperar confiança e bankroll com baixo risco." },
            { id: 2, name: "Micro confortável", min: 600, max: 800, color: "text-orange-400", bg: "bg-orange-500", border: "level-gradient-2", icon: "fa-couch", abiSupport: "$2.00 – $2.50", abiCore: "$3.00 – $4.00", abiShot: "$5.40", pSupport: "30%", pCore: "50%", pShot: "20%", dist: "30% Suporte / 50% Core / 20% Shot", rules: "Aumentar volume gradualmente mantendo a segurança." },
            { id: 3, name: "Zona ideal PKO", min: 800, max: 1000, color: "text-yellow-400", bg: "bg-yellow-500", border: "level-gradient-3", icon: "fa-crosshairs", abiSupport: "$2.50 – $3.20", abiCore: "$4.00 – $5.40", abiShot: "$8.88", pSupport: "25%", pCore: "55%", pShot: "20%", dist: "25% Suporte / 55% Core / 20% Shot", rules: "Maximizar lucros explorando a dinâmica de bounties." },
            { id: 4, name: "Expansão controlada", min: 1000, max: 1300, color: "text-emerald-400", bg: "bg-emerald-500", border: "level-gradient-4", icon: "fa-chart-line", abiSupport: "$3.20 – $4.00", abiCore: "$5.00 – $6.00", abiShot: "$8.88 – $10.80", pSupport: "20%", pCore: "55%", pShot: "25%", dist: "20% Suporte / 55% Core / 25% Shot", rules: "Testar limites superiores com gestão de risco rigorosa." },
            { id: 5, name: "Consolidação", min: 1300, max: 1600, color: "text-cyan-400", bg: "bg-cyan-500", border: "level-gradient-5", icon: "fa-chess-rook", abiSupport: "$4.00 – $5.00", abiCore: "$6.00 – $7.00", abiShot: "$10.80", pSupport: "15%", pCore: "60%", pShot: "25%", dist: "15% Suporte / 60% Core / 25% Shot", rules: "Firmar presença nos limites médios e reduzir variância." },
            { id: 6, name: "Ataque Low Stakes", min: 1600, max: 2200, color: "text-blue-400", bg: "bg-blue-500", border: "level-gradient-6", icon: "fa-jet-fighter-up", abiSupport: "$5.40 – $8.00", abiCore: "$8.88 – $10.80", abiShot: "$16.50 – $22.00", pSupport: "10%", pCore: "60%", pShot: "30%", dist: "10% Suporte / 60% Core / 30% Shot", rules: "Agressividade seletiva nos melhores torneios do dia." },
            { id: 7, name: "Low Stakes Pro", min: 2200, max: 9999999, color: "text-purple-400", bg: "bg-purple-500", border: "level-gradient-7", icon: "fa-crown", abiSupport: "$8.00 – $10.80", abiCore: "$15.00 – $22.00", abiShot: "$33.00+", pSupport: "10%", pCore: "65%", pShot: "25%", dist: "10% Suporte / 65% Core / 25% Shot", rules: "Dominar o field regular e buscar os grandes troféus." }
        ];

        document.addEventListener('alpine:init', () => {
            Alpine.data('pokerApp', () => {
                let _chartInstances = { main: null, volume: null, location: null, mini: null, monthly: null, dow: null, typeDist: null };

                return {
                    activeTab: 'dashboard',
                    sessions: [],
                    settings: { 
                        playerName: 'Hero', 
                        initialBankroll: 1010.36, 
                        dailyStopLoss: 50, 
                        locations: ['GGPoker', 'PokerStars', '888Poker', 'Live'], 
                        syncId: 'minha-banca-pko',
                        gameTypes: ['Online MTT', 'Live MTT', 'Cash Game']
                    },
                    
                    // Form State - Explicitly defined
                    showFormModal: false,
                    isEditing: false,
                    form: { id: null, date: '', startTime: '', endTime: '', type: 'grind', location: '', context: '', volume: '', invested: '', return: '', amount: '', notes: '' },
                    
                    // Aux Inputs
                    newLocationInput: '',
                    newGameTypeInput: '',

                    // Filters
                    chartFilters: { range: 'all', type: 'all' },
                    filters: { month: 'all', type: 'all' },

                    inputCurrency: 'USD',
                    currencyRate: 5.0,
                    showStopLoss: false,
                    showLevels: false,
                    cloudStatus: { connected: false, text: 'Offline', msg: 'Conectando...' },
                    isRemoteUpdate: false,
                    levels: LEVELS_CFG,

                    init() {
                        const saved = localStorage.getItem('poker_pro_v7_pko');
                        if(saved) {
                            try {
                                const data = JSON.parse(saved);
                                this.sessions = data.sessions || [];
                                if (data.settings) {
                                    this.settings = {...this.settings, ...data.settings};
                                    if(!this.settings.gameTypes) this.settings.gameTypes = ['Online MTT', 'Live MTT', 'Cash Game'];
                                }
                            } catch(e) { console.error("Erro ao carregar", e); }
                        }
                        
                        fetch('https://api.exchangerate-api.com/v4/latest/USD')
                            .then(r => r.json()).then(d => this.currencyRate = d.rates.BRL).catch(e => console.log('Erro Cotação'));

                        window.addEventListener('external-data-changed', () => { this.updateCharts(); });

                        if(window.startCloud) window.startCloud(this);
                        else window.addEventListener('firebase-ready', () => { if(window.startCloud) window.startCloud(this); });
                        
                        this.$watch('activeTab', (val) => {
                            Object.keys(_chartInstances).forEach(k => { if (_chartInstances[k]) { _chartInstances[k].destroy(); _chartInstances[k] = null; } });
                            if (val === 'dashboard') this.$nextTick(() => this.renderMiniChart());
                            else if (val === 'charts') this.$nextTick(() => this.renderCharts());
                        });
                        
                        this.$watch('chartFilters', () => { this.renderCharts(); });
                        this.$watch('sessions', () => { this.updateCharts(); });
                        setTimeout(() => this.renderMiniChart(), 500);
                    },

                    // Computed (Global)
                    get bankroll() { return this.settings.initialBankroll + this.sessions.reduce((acc, s) => acc + (s.profit || 0), 0); },
                    get totalProfit() { return this.sessions.filter(s => s.type === 'grind').reduce((acc, s) => acc + (s.profit || 0), 0); },
                    get totalInvested() { return this.sessions.filter(s => s.type === 'grind').reduce((acc, s) => acc + (s.invested || 0), 0); },
                    get totalVolume() { return this.sessions.filter(s => s.type === 'grind').reduce((acc, s) => acc + (s.volume || 0), 0); },
                    get profitPerGame() { return this.totalVolume > 0 ? (this.totalProfit / this.totalVolume) : 0; },
                    get roi() { 
                        const inv = this.sessions.filter(s => s.type === 'grind').reduce((acc, s) => acc + (s.invested || 0), 0);
                        return inv > 0 ? ((this.totalProfit / inv) * 100).toFixed(1) : 0; 
                    },
                    get abi() { 
                        const inv = this.sessions.filter(s => s.type === 'grind').reduce((acc, s) => acc + (s.invested || 0), 0);
                        return this.totalVolume > 0 ? (inv / this.totalVolume) : 0; 
                    },
                    get currencySymbol() { return this.inputCurrency === 'USD' ? '$' : 'R$'; },
                    get todaysLoss() {
                        const today = new Date().toISOString().split('T')[0];
                        const loss = this.sessions.filter(s => s.date === today && s.type === 'grind').reduce((acc, s) => acc + (s.profit || 0), 0);
                        return loss < 0 ? Math.abs(loss) : 0;
                    },
                    get currentLevelObj() { return this.levels.find(l => this.bankroll >= l.min && this.bankroll < l.max) || this.levels[this.levels.length-1]; },
                    get nextLevelTarget() {
                        const idx = this.levels.indexOf(this.currentLevelObj);
                        return this.levels[idx+1] ? this.formatMoney(this.levels[idx+1].min) : 'MAX';
                    },
                    get nextLevelGap() {
                        const idx = this.levels.indexOf(this.currentLevelObj);
                        if (!this.levels[idx+1]) return null;
                        const gap = this.levels[idx+1].min - this.bankroll;
                        return gap > 0 ? this.formatMoney(gap) : '$0.00';
                    },
                    get levelProgress() {
                        const lvl = this.currentLevelObj;
                        const next = this.levels[this.levels.indexOf(lvl)+1];
                        if(!next) return 100;
                        return Math.min(100, Math.max(0, ((this.bankroll - lvl.min) / (next.min - lvl.min)) * 100));
                    },
                    get streak() {
                        const dates = [...new Set(this.sessions.filter(s => s.type === 'grind').map(s => s.date))].sort();
                        if(dates.length === 0) return 0;
                        let streak = 0, check = new Date();
                        const hasToday = dates.includes(check.toISOString().split('T')[0]);
                        if(!hasToday) check.setDate(check.getDate() - 1);
                        while(true) {
                            const dateStr = check.toISOString().split('T')[0];
                            if(dates.includes(dateStr)) { streak++; check.setDate(check.getDate()-1); } else break;
                        }
                        return streak;
                    },

                    // Computed (Filtered for Charts)
                    get filteredChartSessions() {
                        let data = this.sessions.filter(s => s.type === 'grind');
                        if (this.chartFilters.type !== 'all') {
                            data = data.filter(s => s.context === this.chartFilters.type);
                        }
                        const now = new Date();
                        if (this.chartFilters.range === 'year') {
                            data = data.filter(s => new Date(s.date).getFullYear() === now.getFullYear());
                        } else if (this.chartFilters.range === '30d') {
                            const thirtyDaysAgo = new Date(now.getTime() - 30*24*60*60*1000);
                            data = data.filter(s => new Date(s.date) >= thirtyDaysAgo);
                        } else if (this.chartFilters.range === '90d') {
                            const ninetyDaysAgo = new Date(now.getTime() - 90*24*60*60*1000);
                            data = data.filter(s => new Date(s.date) >= ninetyDaysAgo);
                        }
                        return data.sort((a,b) => new Date(a.date) - new Date(b.date));
                    },
                    
                    get chartStats() {
                         const sessions = this.filteredChartSessions;
                         const profit = sessions.reduce((acc, s) => acc + s.profit, 0);
                         const invested = sessions.reduce((acc, s) => acc + s.invested, 0);
                         const volume = sessions.reduce((acc, s) => acc + s.volume, 0);
                         const roi = invested > 0 ? ((profit / invested) * 100).toFixed(1) : 0;
                         return { profit, volume, roi };
                    },

                    // Computed (Records Tab)
                    get filteredSessions() {
                        return this.sessions.filter(s => {
                            const dateMatch = this.filters.month === 'all' || s.date.startsWith(this.filters.month);
                            const typeMatch = this.filters.type === 'all' || s.type === this.filters.type;
                            return dateMatch && typeMatch;
                        }).sort((a,b) => new Date(b.date + 'T' + (b.startTime || '00:00')) - new Date(a.date + 'T' + (a.startTime || '00:00')));
                    },
                    get uniqueMonths() {
                        const months = new Set(this.sessions.map(s => s.date.slice(0, 7)));
                        return Array.from(months).sort().reverse();
                    },

                    // Actions
                    openForm(sessionToEdit = null) {
                        this.isEditing = !!sessionToEdit;
                        if (sessionToEdit) {
                            this.form = JSON.parse(JSON.stringify(sessionToEdit));
                            if(!this.form.notes) this.form.notes = '';
                            if(!this.form.startTime) this.form.startTime = '';
                            if(!this.form.endTime) this.form.endTime = '';
                        } else {
                            const now = new Date();
                            const oneHourAgo = new Date(now.getTime() - 60*60*1000);
                            this.form = {
                                id: null, date: now.toISOString().split('T')[0], startTime: oneHourAgo.toTimeString().slice(0,5), endTime: now.toTimeString().slice(0,5),
                                type: 'grind', location: this.settings.locations[0] || '', context: this.settings.gameTypes[0] || '', volume: '', invested: '', return: '', amount: '', notes: ''
                            };
                        }
                        this.showFormModal = true;
                    },

                    saveSession() {
                        const f = this.form;
                        const mult = this.inputCurrency === 'BRL' ? (1/this.currencyRate) : 1;
                        // Garantir ID único se for novo
                        const sessionId = f.id ? f.id : Date.now();
                        
                        let session = {
                            id: sessionId,
                            date: f.date, startTime: f.startTime, endTime: f.endTime,
                            type: f.type, location: f.type === 'grind' ? f.location : (f.type === 'deposit' ? 'Depósito' : 'Saque'),
                            notes: f.notes || ''
                        };

                        if(f.type === 'grind') {
                            session.volume = f.volume || 0;
                            session.invested = (f.invested || 0) * mult;
                            session.return = (f.return || 0) * mult;
                            session.profit = session.return - session.invested;
                            session.context = f.context;
                            if(session.profit < 0 && (this.todaysLoss + Math.abs(session.profit)) >= this.settings.dailyStopLoss) {
                                this.showStopLoss = true;
                            }
                        } else {
                            const val = (f.amount || 0) * mult;
                            session.profit = f.type === 'deposit' ? val : -val;
                            session.invested = 0; session.return = 0;
                        }

                        if (this.isEditing) {
                            const index = this.sessions.findIndex(s => s.id === sessionId);
                            if (index !== -1) {
                                this.sessions.splice(index, 1, session);
                            }
                        } else {
                            this.sessions.push(session);
                        }
                        
                        this.saveLocal();
                        this.showFormModal = false;
                        this.updateCharts();
                    },

                    deleteSession(id) {
                        if(confirm('Tem certeza que deseja apagar este registro?')) {
                            this.sessions = this.sessions.filter(s => s.id !== id);
                            this.saveLocal();
                        }
                    },

                    addLocation() { if(this.newLocationInput && !this.settings.locations.includes(this.newLocationInput)) { this.settings.locations.push(this.newLocationInput); this.newLocationInput = ''; this.saveLocal(); } },
                    removeLocation(loc) { this.settings.locations = this.settings.locations.filter(l => l !== loc); this.saveLocal(); },
                    addGameType() { if(this.newGameTypeInput && !this.settings.gameTypes.includes(this.newGameTypeInput)) { this.settings.gameTypes.push(this.newGameTypeInput); this.newGameTypeInput = ''; this.saveLocal(); } },
                    removeGameType(type) { this.settings.gameTypes = this.settings.gameTypes.filter(t => t !== type); this.saveLocal(); },

                    saveLocal(sync = true) {
                        localStorage.setItem('poker_pro_v7_pko', JSON.stringify({ sessions: this.sessions, settings: this.settings }));
                        if(sync && this.pushToCloud) this.pushToCloud();
                    },
                    formatMoney(val) { return '$' + (val || 0).toFixed(2); },
                    formatBRL(val) { return 'R$ ' + ((val || 0) * this.currencyRate).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}); },
                    formatDate(s) { if(!s) return ''; const [y,m,d] = s.split('-'); return `${d}/${m}`; },
                    isCurrentLevel(l) { return this.currentLevelObj.id === l.id; },
                    isLocked(l) { return this.bankroll < l.min; },
                    
                    exportData() {
                        const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({sessions: this.sessions, settings: this.settings}));
                        const node = document.createElement('a'); node.setAttribute("href", str); node.setAttribute("download", "bankroll_backup.json");
                        document.body.appendChild(node); node.click(); node.remove();
                    },
                    exportCSV() {
                        let csvContent = "data:text/csv;charset=utf-8,ID,Data,Hora Inicio,Hora Fim,Tipo,Local,Contexto,Volume,Investido,Retorno,Lucro,Notas\n";
                        this.sessions.forEach(s => {
                            let row = [
                                s.id, s.date, s.startTime || '', s.endTime || '', s.type, s.location || '', s.context || '', 
                                s.volume || 0, s.invested || 0, s.return || 0, s.profit || 0, (s.notes || '').replace(/,/g, ';')
                            ].join(",");
                            csvContent += row + "\n";
                        });
                        const encodedUri = encodeURI(csvContent);
                        const link = document.createElement("a");
                        link.setAttribute("href", encodedUri);
                        link.setAttribute("download", "poker_sessions.csv");
                        document.body.appendChild(link); link.click(); link.remove();
                    },
                    importData(e) {
                        const reader = new FileReader();
                        reader.onload = (evt) => {
                            try {
                                const d = JSON.parse(evt.target.result);
                                this.sessions = d.sessions || [];
                                if(d.settings) this.settings = d.settings;
                                this.saveLocal(); location.reload();
                            } catch(err) { alert('Arquivo inválido'); }
                        };
                        reader.readAsText(e.target.files[0]);
                    },
                    resetAll() { if(confirm("Isso apagará tudo. Confirmar?")) { localStorage.removeItem('poker_pro_v7_pko'); location.reload(); } },
                    
                    destroyCharts(keys) { keys.forEach(k => { if (this.charts[k]) { this.charts[k].destroy(); this.charts[k] = null; } }); },
                    
                    renderMiniChart() {
                        this.$nextTick(() => {
                            const el = document.getElementById('miniChartEl');
                            if(!el || el.offsetParent === null) return;
                            const ctx = el.getContext('2d');
                            if(_chartInstances.mini) {
                                const data = this.buildChartData();
                                _chartInstances.mini.data.labels = data.labels;
                                _chartInstances.mini.data.datasets[0].data = data.values;
                                _chartInstances.mini.update('none');
                                return;
                            }
                            let gradient = null;
                            try {
                                gradient = ctx.createLinearGradient(0, 0, 0, el.clientHeight || 100);
                                gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
                                gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
                            } catch(e) { gradient = 'rgba(59, 130, 246, 0.1)'; }
                            const data = this.buildChartData();
                            _chartInstances.mini = new Chart(ctx, {
                                type: 'line',
                                data: { labels: data.labels, datasets: [{ data: data.values, borderColor: '#3b82f6', backgroundColor: gradient, borderWidth: 2, fill: true, tension: 0.4, pointRadius: 0 }] },
                                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { x: {display:false}, y: {display:false} } }
                            });
                        });
                    },
                    renderCharts() {
                        this.$nextTick(() => {
                            const sessions = this.filteredChartSessions;
                            if (sessions.length === 0 && !this.settings.initialBankroll) return; 

                            const elMain = document.getElementById('mainChartEl');
                            if (elMain && elMain.offsetParent !== null) {
                                const data = this.buildFilteredChartData(sessions);
                                const ctxMain = elMain.getContext('2d');
                                
                                if (_chartInstances.main) {
                                    _chartInstances.main.data.labels = data.labels;
                                    _chartInstances.main.data.datasets[0].data = data.values;
                                    _chartInstances.main.update('none');
                                } else {
                                    let gradientMain = ctxMain.createLinearGradient(0, 0, 0, 300);
                                    gradientMain.addColorStop(0, 'rgba(16, 185, 129, 0.4)');
                                    gradientMain.addColorStop(1, 'rgba(16, 185, 129, 0)');

                                    _chartInstances.main = new Chart(ctxMain, {
                                        type: 'line',
                                        data: { labels: data.labels, datasets: [{ label: 'Bankroll ($)', data: data.values, borderColor: '#10b981', backgroundColor: gradientMain, borderWidth: 2, fill: true, tension: 0.3, pointRadius: 3 }] },
                                        options: { responsive: true, maintainAspectRatio: false, scales: { y: {grid: {color: '#334155'}, ticks: {color: '#94a3b8'}}, x: {grid: {display: false}, ticks: {color: '#94a3b8'}} }, plugins: { legend: {labels: {color: '#e2e8f0'}} } }
                                    });
                                }
                            }
                            
                            const elMonthly = document.getElementById('monthlyChartEl');
                            if (elMonthly && elMonthly.offsetParent !== null) {
                                const monthlyData = this.buildMonthlyProfitData(sessions);
                                const ctxMonthly = elMonthly.getContext('2d');
                                if(_chartInstances.monthly) {
                                    _chartInstances.monthly.data.labels = monthlyData.labels;
                                    _chartInstances.monthly.data.datasets[0].data = monthlyData.values;
                                    _chartInstances.monthly.data.datasets[0].backgroundColor = monthlyData.values.map(v => v >= 0 ? '#10b981' : '#ef4444');
                                    _chartInstances.monthly.update('none');
                                } else {
                                    _chartInstances.monthly = new Chart(ctxMonthly, {
                                        type: 'bar',
                                        data: { labels: monthlyData.labels, datasets: [{ label: 'Lucro ($)', data: monthlyData.values, backgroundColor: monthlyData.values.map(v => v >= 0 ? '#10b981' : '#ef4444'), borderRadius: 4 }] },
                                        options: { responsive: true, maintainAspectRatio: false, scales: { y: {grid: {color: '#334155'}, ticks: {color: '#94a3b8'}}, x: {grid: {display: false}, ticks: {color: '#94a3b8'}} }, plugins: { legend: {display: false} } }
                                    });
                                }
                            }

                            const elVolume = document.getElementById('volumeChartEl');
                            if (elVolume && elVolume.offsetParent !== null) {
                                const ctxVolume = elVolume.getContext('2d');
                                const volData = this.buildVolumeData();
                                if(_chartInstances.volume) {
                                    _chartInstances.volume.data.labels = volData.labels;
                                    _chartInstances.volume.data.datasets[0].data = volData.values;
                                    _chartInstances.volume.update('none');
                                } else {
                                    _chartInstances.volume = new Chart(ctxVolume, {
                                        type: 'bar',
                                        data: { labels: volData.labels, datasets: [{ label: 'Jogos', data: volData.values, backgroundColor: '#3b82f6', borderRadius: 4 }] },
                                        options: { responsive: true, maintainAspectRatio: false, scales: { y: {grid: {color: '#334155'}, ticks: {color: '#94a3b8'}}, x: {grid: {display: false}, ticks: {color: '#94a3b8'}} }, plugins: { legend: {display: false} } }
                                    });
                                }
                            }

                            const elLoc = document.getElementById('locationChartEl');
                            if (elLoc && elLoc.offsetParent !== null) {
                                const ctxLoc = elLoc.getContext('2d');
                                const locData = this.buildLocationData();
                                if(_chartInstances.location) {
                                    _chartInstances.location.data.labels = locData.labels;
                                    _chartInstances.location.data.datasets[0].data = locData.values;
                                    _chartInstances.location.data.datasets[0].backgroundColor = locData.values.map(v => v >= 0 ? '#10b981' : '#ef4444');
                                    _chartInstances.location.update('none');
                                } else {
                                    _chartInstances.location = new Chart(ctxLoc, {
                                        type: 'bar', indexAxis: 'y',
                                        data: { labels: locData.labels, datasets: [{ label: 'Profit ($)', data: locData.values, backgroundColor: locData.values.map(v => v >= 0 ? '#10b981' : '#ef4444'), borderRadius: 4 }] },
                                        options: { responsive: true, maintainAspectRatio: false, scales: { x: {grid: {color: '#334155'}, ticks: {color: '#94a3b8'}}, y: {grid: {display: false}, ticks: {color: '#94a3b8'}} }, plugins: { legend: {display: false} } }
                                    });
                                }
                            }
                            
                            const elDow = document.getElementById('dowChartEl');
                            if (elDow && elDow.offsetParent !== null) {
                                const dowData = this.buildDayOfWeekData(sessions);
                                const ctxDow = elDow.getContext('2d');
                                if(_chartInstances.dow) {
                                    _chartInstances.dow.data.labels = dowData.labels;
                                    _chartInstances.dow.data.datasets[0].data = dowData.values;
                                    _chartInstances.dow.update('none');
                                } else {
                                    _chartInstances.dow = new Chart(ctxDow, {
                                        type: 'bar',
                                        data: { labels: dowData.labels, datasets: [{ label: 'Lucro Médio ($)', data: dowData.values, backgroundColor: '#3b82f6', borderRadius: 4 }] },
                                        options: { responsive: true, maintainAspectRatio: false, scales: { y: {grid: {color: '#334155'}, ticks: {color: '#94a3b8'}}, x: {grid: {display: false}, ticks: {color: '#94a3b8'}} }, plugins: { legend: {display: false} } }
                                    });
                                }
                            }

                            const elType = document.getElementById('typeDistChartEl');
                            if (elType && elType.offsetParent !== null) {
                                const typeData = this.buildLocationVolumeData(sessions);
                                const ctxType = elType.getContext('2d');
                                if(_chartInstances.typeDist) {
                                     _chartInstances.typeDist.data.labels = typeData.labels;
                                     _chartInstances.typeDist.data.datasets[0].data = typeData.values;
                                     _chartInstances.typeDist.update('none');
                                } else {
                                    _chartInstances.typeDist = new Chart(ctxType, {
                                        type: 'doughnut',
                                        data: { labels: typeData.labels, datasets: [{ data: typeData.values, backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'], borderWidth: 0 }] },
                                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {position: 'right', labels: {color: '#e2e8f0', boxWidth: 10}} } }
                                    });
                                }
                            }
                        });
                    },
                    updateCharts() { if(this.activeTab === 'charts') this.renderCharts(); else if(this.activeTab === 'dashboard') this.renderMiniChart(); },
                    
                    buildChartData() {
                        let b = this.settings.initialBankroll;
                        let values = [b], labels = ['Start'];
                        [...this.sessions].sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(s => { b += (s.profit || 0); values.push(b); labels.push(this.formatDate(s.date)); });
                        return { values, labels };
                    },
                    buildFilteredChartData(sessions) {
                        let running = this.chartFilters.range === 'all' ? this.settings.initialBankroll : 0;
                        let values = [running], labels = ['Início'];
                        sessions.forEach(s => { running += (s.profit || 0); values.push(running); labels.push(this.formatDate(s.date)); });
                        return { values, labels };
                    },
                    buildMonthlyProfitData(sessions) {
                        const agg = {};
                        sessions.forEach(s => { const key = s.date.slice(0, 7); agg[key] = (agg[key] || 0) + s.profit; });
                        return { labels: Object.keys(agg).sort(), values: Object.keys(agg).sort().map(k => agg[k]) };
                    },
                    buildDayOfWeekData(sessions) {
                        const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                        const agg = Array(7).fill(0);
                        sessions.forEach(s => { const dayIdx = new Date(s.date + 'T12:00:00').getDay(); agg[dayIdx] += s.profit; });
                        return { labels: days, values: agg };
                    },
                    buildLocationVolumeData(sessions) {
                        const agg = {};
                        sessions.forEach(s => { const k = s.location || 'Outros'; agg[k] = (agg[k] || 0) + (s.volume || 1); });
                        return { labels: Object.keys(agg), values: Object.values(agg) };
                    },
                    buildVolumeData() { return this.buildMonthlyVolumeData(this.sessions); },
                    buildMonthlyVolumeData(sessions) {
                        const agg = {};
                        sessions.forEach(s => { const key = s.date.slice(0, 7); agg[key] = (agg[key] || 0) + (s.volume || 0); });
                        return { labels: Object.keys(agg).sort(), values: Object.keys(agg).sort().map(k => agg[k]) };
                    },
                    buildLocationData() {
                        const profits = {};
                        this.sessions.filter(s => s.type === 'grind').forEach(s => { const loc = s.location || 'Outros'; profits[loc] = (profits[loc] || 0) + (s.profit || 0); });
                        return { labels: Object.keys(profits), values: Object.values(profits) };
                    }
                }
            });
        });
    </script>
</head>

<body class="min-h-screen flex flex-col font-sans text-sm md:text-base relative selection:bg-primary-500 selection:text-white" x-data="pokerApp" x-cloak>

    <!-- FLOATING ACTION BUTTON (MOBILE) -->
    <div class="md:hidden fixed bottom-24 right-4 z-50">
        <button @click="openForm()" class="w-14 h-14 bg-primary-600 rounded-full shadow-lg shadow-primary-600/40 flex items-center justify-center text-white transition-transform active:scale-90">
            <i class="fa-solid fa-plus text-xl"></i>
        </button>
    </div>

    <!-- OVERLAY DE STOP LOSS -->
    <div x-show="showStopLoss" class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center backdrop-blur-md transition-opacity"
         x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
        <div class="glass-card p-8 rounded-3xl border border-red-500/50 shadow-[0_0_50px_rgba(239,68,68,0.2)] text-center max-w-md animate-pulse-soft">
            <div class="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fa-solid fa-hand-paper text-4xl text-red-500"></i>
            </div>
            <h2 class="text-3xl font-bold text-white mb-2">Stop Loss Atingido</h2>
            <p class="text-lg text-slate-300 mb-8">Você atingiu o limite de <span class="text-red-400 font-mono font-bold" x-text="formatMoney(todaysLoss)"></span> hoje.</p>
            <button @click="showStopLoss = false" class="bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-10 rounded-full transition-all shadow-lg hover:shadow-red-500/30">
                Encerrar Sessão
            </button>
        </div>
    </div>

    <!-- MODAL DE NÍVEIS -->
    <div x-show="showLevels" class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center backdrop-blur-md p-4 transition-opacity"
         x-transition>
        <div @click.outside="showLevels = false" class="glass-card w-full max-w-5xl max-h-[90vh] rounded-3xl flex flex-col overflow-hidden animate-slide-up bg-dark-900 border border-white/10">
            <div class="p-6 border-b border-white/5 flex justify-between items-center bg-gradient-to-r from-dark-950/80 to-dark-900/80">
                <div>
                    <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-primary-600/20 flex items-center justify-center text-primary-500 shadow-lg shadow-primary-500/10">
                            <i class="fa-solid fa-layer-group"></i>
                        </div>
                        Plano de Carreira PKO
                    </h2>
                    <p class="text-slate-400 text-sm mt-1 ml-14">Sua jornada do micro ao high stakes</p>
                </div>
                <button @click="showLevels = false" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-slate-400 hover:text-white transition-all">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="p-6 overflow-y-auto space-y-6 custom-scrollbar bg-dark-950/30">
                <template x-for="lvl in levels" :key="lvl.id">
                    <div class="relative rounded-2xl border transition-all duration-300 group overflow-hidden"
                         :class="{
                            'bg-dark-900/90 border-primary-500/50 ring-1 ring-primary-500/30 shadow-2xl shadow-black/50 scale-[1.01]': isCurrentLevel(lvl),
                            'bg-dark-900/30 border-white/5 opacity-50 hover:opacity-80 hover:border-white/10': isLocked(lvl),
                            'bg-dark-900/40 border-emerald-500/20 hover:border-emerald-500/40': !isLocked(lvl) && !isCurrentLevel(lvl)
                         }">
                         
                        <div class="absolute left-0 top-0 bottom-0 w-1.5 transition-colors duration-300" 
                             :class="isCurrentLevel(lvl) ? 'bg-primary-500' : (isLocked(lvl) ? 'bg-slate-800' : 'bg-emerald-500')">
                        </div>

                        <div class="p-6 pl-8">
                            <div class="grid lg:grid-cols-[1.2fr_2fr] gap-8">
                                <div class="flex flex-col justify-center border-b lg:border-b-0 lg:border-r border-white/5 pb-6 lg:pb-0 lg:pr-8">
                                    <div class="flex items-center gap-4 mb-4">
                                        <div class="w-14 h-14 rounded-2xl flex items-center justify-center text-2xl shadow-inner border border-white/10 transition-transform group-hover:scale-105" 
                                             :class="isLocked(lvl) ? 'bg-slate-800 text-slate-600' : lvl.bg + ' ' + lvl.color.replace('text-', 'text-white ')">
                                            <i :class="['fa-solid', lvl.icon]"></i>
                                        </div>
                                        
                                        <div>
                                            <div class="flex items-center gap-2 mb-1">
                                                <h3 class="text-xl font-bold text-white tracking-tight" x-text="lvl.name"></h3>
                                                <span x-show="isCurrentLevel(lvl)" class="px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-primary-500 text-white shadow-lg shadow-primary-500/20 animate-pulse">Atual</span>
                                                <span x-show="!isLocked(lvl) && !isCurrentLevel(lvl)" class="text-emerald-500 text-sm"><i class="fa-solid fa-circle-check"></i></span>
                                                <span x-show="isLocked(lvl)" class="text-slate-600 text-sm"><i class="fa-solid fa-lock"></i></span>
                                            </div>
                                            
                                            <div class="inline-flex items-center gap-2 text-xs font-mono bg-black/30 px-3 py-1.5 rounded-lg border border-white/5">
                                                <span class="text-slate-400" x-text="formatMoney(lvl.min)"></span>
                                                <i class="fa-solid fa-arrow-right text-[10px] text-slate-600"></i>
                                                <span class="text-white font-bold" x-text="lvl.max > 99999 ? '∞' : formatMoney(lvl.max)"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <div x-show="isCurrentLevel(lvl)" class="mt-2 bg-dark-950/50 p-4 rounded-xl border border-white/5 shadow-inner">
                                        <div class="flex justify-between text-[11px] mb-2 font-mono">
                                            <span class="text-slate-400">Progresso do Nível</span>
                                            <span class="text-primary-400 font-bold" x-text="'Faltam ' + nextLevelGap"></span>
                                        </div>
                                        <div class="w-full bg-slate-800 h-2 rounded-full overflow-hidden">
                                            <div class="h-full bg-gradient-to-r from-primary-600 to-primary-400 relative" :style="'width: ' + levelProgress + '%'">
                                                <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4 flex items-start gap-2 text-xs text-slate-400 bg-white/5 p-3 rounded-lg border border-white/5">
                                        <i class="fa-solid fa-crosshairs mt-0.5 text-slate-500"></i>
                                        <p class="leading-relaxed italic" x-text="'&quot;' + lvl.rules + '&quot;'"></p>
                                    </div>
                                </div>

                                <div class="flex flex-col justify-center">
                                    <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                                        <i class="fa-solid fa-chess-board"></i> Estratégia de Jogo
                                    </h4>

                                    <div class="grid grid-cols-3 gap-3 mb-5">
                                        <div class="bg-dark-950/40 p-3 rounded-xl border border-white/5 text-center transition-colors hover:border-slate-600/30">
                                            <p class="text-[9px] uppercase font-bold text-slate-500 mb-1">Suporte</p>
                                            <p class="text-sm font-mono text-slate-300" x-text="lvl.abiSupport"></p>
                                        </div>
                                        
                                        <div class="bg-gradient-to-b from-primary-500/10 to-transparent p-3 rounded-xl border border-primary-500/20 text-center relative overflow-hidden">
                                            <div class="absolute top-0 left-0 w-full h-1 bg-primary-500"></div>
                                            <p class="text-[9px] uppercase font-bold text-primary-400 mb-1">Core (Principal)</p>
                                            <p class="text-base font-mono text-white font-bold" x-text="lvl.abiCore"></p>
                                        </div>
                                        
                                        <div class="bg-dark-950/40 p-3 rounded-xl border border-white/5 text-center transition-colors hover:border-red-500/20 group-hover:border-red-500/10">
                                            <p class="text-[9px] uppercase font-bold text-slate-500 group-hover:text-red-400/70 mb-1">Shot</p>
                                            <p class="text-sm font-mono text-slate-300 group-hover:text-red-100" x-text="lvl.abiShot"></p>
                                        </div>
                                    </div>

                                    <div class="bg-white/5 p-4 rounded-xl border border-white/5">
                                        <div class="flex justify-between items-end mb-2">
                                            <span class="text-[10px] uppercase font-bold text-slate-500">Mix de Volume Recomendado</span>
                                            <span class="text-[10px] font-mono text-white bg-primary-600 px-1.5 rounded" x-text="lvl.pCore + ' Core'"></span>
                                        </div>
                                        <div class="flex h-3 w-full rounded-full overflow-hidden bg-slate-900 shadow-inner">
                                            <div class="bg-slate-500 h-full flex items-center justify-center text-[8px] text-black font-bold" :style="'width:' + lvl.pSupport" title="Suporte">Sup</div>
                                            <div class="bg-primary-500 h-full flex items-center justify-center text-[8px] text-white font-bold" :style="'width:' + lvl.pCore" title="Core">Core</div>
                                            <div class="bg-red-500 h-full flex items-center justify-center text-[8px] text-white font-bold" :style="'width:' + lvl.pShot" title="Shot">Shot</div>
                                        </div>
                                        <div class="flex justify-between mt-1 text-[9px] text-slate-500 px-1">
                                            <span x-text="lvl.pSupport"></span>
                                            <span x-text="lvl.pCore" class="text-primary-400"></span>
                                            <span x-text="lvl.pShot"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            
            <div class="p-4 bg-dark-950/80 border-t border-white/5 text-center backdrop-blur text-slate-500 text-xs">
                <p><i class="fa-solid fa-circle-info mr-1"></i> A disciplina no respeito aos limites de ABI (Average Buy-in) é o fator #1 para evitar a ruína.</p>
            </div>
        </div>
    </div>

    <!-- MODAL DE FORMULÁRIO (ADD/EDIT) -->
    <div x-show="showFormModal" class="fixed inset-0 z-50 bg-black/90 flex items-center justify-center backdrop-blur-md p-4 transition-opacity" x-transition x-cloak>
        <div @click.outside="showFormModal = false" class="glass-card w-full max-w-lg rounded-2xl flex flex-col overflow-hidden animate-slide-up bg-dark-900">
            <div class="p-6 border-b border-white/5 flex justify-between items-center bg-white/5">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    <i class="fa-solid" :class="isEditing ? 'fa-pen-to-square' : 'fa-plus-circle'"></i>
                    <span x-text="isEditing ? 'Editar Registro' : 'Nova Sessão'"></span>
                </h2>
                <button @click="showFormModal = false" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <form @submit.prevent="saveSession" class="p-6 space-y-5 overflow-y-auto max-h-[80vh] custom-scrollbar">
                <!-- Type Selector -->
                <div class="flex gap-2 p-1 bg-dark-950 rounded-lg">
                    <template x-for="type in [{id:'grind', l:'Grind'}, {id:'deposit', l:'Depósito'}, {id:'withdraw', l:'Saque'}]">
                        <button type="button" @click="form.type = type.id" 
                            class="flex-1 py-2 rounded-md text-xs font-bold transition-all"
                            :class="form.type === type.id ? 'bg-primary-600 text-white shadow' : 'text-slate-400 hover:text-slate-200'">
                            <span x-text="type.l"></span>
                        </button>
                    </template>
                </div>

                <!-- Fields -->
                <div x-show="form.type === 'grind'" class="space-y-4 animate-fade-in">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Data</label>
                            <input type="date" x-model="form.date" required class="w-full p-3 rounded-xl glass-input text-sm">
                        </div>
                        <div>
                            <label class="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Local</label>
                            <select x-model="form.location" class="w-full p-3 rounded-xl glass-input text-sm appearance-none">
                                <template x-for="loc in settings.locations"><option :value="loc" x-text="loc"></option></template>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Hora Início</label>
                            <input type="time" x-model="form.startTime" class="w-full p-3 rounded-xl glass-input text-sm">
                        </div>
                        <div>
                            <label class="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Hora Fim</label>
                            <input type="time" x-model="form.endTime" class="w-full p-3 rounded-xl glass-input text-sm">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Tipo de Jogo</label>
                            <select x-model="form.context" class="w-full p-3 rounded-xl glass-input text-sm appearance-none">
                                <template x-for="gt in settings.gameTypes"><option :value="gt" x-text="gt"></option></template>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Qtd Jogos</label>
                            <input type="number" x-model.number="form.volume" placeholder="0" class="w-full p-3 rounded-xl glass-input text-sm">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 p-4 rounded-xl bg-white/5 border border-white/5">
                        <div>
                            <label class="text-[10px] uppercase font-bold text-red-400 mb-1 block" x-text="'Investido ('+currencySymbol+')'"></label>
                            <input type="number" step="0.01" x-model.number="form.invested" class="w-full p-2 rounded-lg bg-dark-900 border border-white/10 text-white focus:border-red-500 outline-none text-sm">
                        </div>
                        <div>
                            <label class="text-[10px] uppercase font-bold text-emerald-400 mb-1 block" x-text="'Retorno ('+currencySymbol+')'"></label>
                            <input type="number" step="0.01" x-model.number="form.return" class="w-full p-2 rounded-lg bg-dark-900 border border-white/10 text-white focus:border-emerald-500 outline-none text-sm">
                        </div>
                    </div>
                </div>

                <div x-show="form.type !== 'grind'" class="animate-fade-in space-y-4">
                     <div>
                        <label class="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Data</label>
                        <input type="date" x-model="form.date" required class="w-full p-3 rounded-xl glass-input text-sm">
                    </div>
                    <div class="p-6 rounded-xl bg-white/5 border border-white/5 text-center">
                        <label class="text-xs font-bold text-slate-400 mb-2 block" x-text="'Valor ('+currencySymbol+')'"></label>
                        <input type="number" step="0.01" x-model.number="form.amount" class="w-full bg-transparent text-center text-3xl font-mono text-white border-b border-white/20 focus:border-primary-500 outline-none pb-2" placeholder="0.00">
                    </div>
                </div>

                <div>
                    <label class="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Notas</label>
                    <textarea x-model="form.notes" class="w-full p-3 rounded-xl glass-input text-sm h-24 resize-none" placeholder="Detalhes..."></textarea>
                </div>

                <div class="pt-2">
                    <button type="submit" class="w-full py-4 rounded-xl bg-primary-600 hover:bg-primary-500 text-white font-bold shadow-lg shadow-primary-600/20 transition-all flex items-center justify-center gap-2">
                        <i class="fa-solid fa-save"></i>
                        <span x-text="isEditing ? 'Salvar Alterações' : 'Adicionar Registro'"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- HEADER -->
    <header class="fixed top-0 w-full z-40 bg-dark-950/80 backdrop-blur-xl border-b border-white/5">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <!-- Logo -->
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary-500 to-blue-700 flex items-center justify-center text-white shadow-lg shadow-blue-500/20">
                        <i class="fa-solid fa-layer-group text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white tracking-tight leading-none">POKER PRO</h1>
                        <p class="text-[10px] text-primary-500 font-mono tracking-[0.2em] font-bold mt-1">MANAGER v7</p>
                    </div>
                </div>

                <!-- Nav Desktop -->
                <nav class="hidden md:flex bg-white/5 p-1 rounded-full border border-white/5">
                    <template x-for="t in ['dashboard', 'records', 'charts', 'settings']">
                        <button @click="activeTab = t; if(t==='charts') renderCharts(); if(t==='dashboard') renderMiniChart();" 
                                class="px-6 py-2 rounded-full text-sm font-medium transition-all duration-300 flex items-center gap-2"
                                :class="activeTab === t ? 'bg-primary-600 text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-white/5'">
                            <i :class="{'dashboard': 'fa-chart-pie', 'records': 'fa-list-ul', 'charts': 'fa-chart-line', 'settings': 'fa-gear'}[t]" class="fa-solid"></i>
                            <span class="capitalize" x-text="t === 'records' ? 'Registros' : t"></span>
                        </button>
                    </template>
                </nav>

                <!-- Status Pill -->
                <div class="flex items-center gap-4">
                    <div class="hidden sm:flex flex-col items-end">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-slate-400 font-medium" x-text="settings.playerName"></span>
                            <span class="text-2xl font-mono font-bold text-white tracking-tight" x-text="formatMoney(bankroll)"></span>
                        </div>
                        <div class="flex items-center gap-2 text-[10px] text-slate-500 font-mono bg-white/5 px-2 py-0.5 rounded-md">
                            <span x-text="formatBRL(bankroll)"></span>
                            <span class="w-1 h-1 rounded-full bg-slate-600"></span>
                            <span x-text="'USD ' + currencyRate.toFixed(2)"></span>
                        </div>
                    </div>
                    
                    <!-- Cloud Status Indicator -->
                    <div class="flex items-center gap-2 bg-white/5 px-3 py-1.5 rounded-full border border-white/5" :title="cloudStatus.msg">
                        <div class="h-2 w-2 rounded-full shadow-[0_0_10px_currentColor]" 
                             :class="cloudStatus.connected ? 'bg-emerald-500 text-emerald-500' : (cloudStatus.text === 'Offline' ? 'bg-red-500 text-red-500' : 'bg-yellow-500 text-yellow-500 animate-pulse')"></div>
                        <span class="text-[10px] font-bold uppercase tracking-wider" 
                              :class="cloudStatus.connected ? 'text-emerald-500' : (cloudStatus.text === 'Offline' ? 'text-red-500' : 'text-yellow-500')" 
                              x-text="cloudStatus.text"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Mobile Nav -->
        <div class="md:hidden border-t border-white/5 bg-dark-900/50 backdrop-blur-lg">
            <div class="flex justify-around p-2">
                <template x-for="t in ['dashboard', 'records', 'charts', 'settings']">
                    <button @click="activeTab = t; if(t==='charts') renderCharts(); if(t==='dashboard') renderMiniChart();" 
                            class="flex-1 py-3 flex flex-col items-center gap-1 text-xs font-medium transition-colors"
                            :class="activeTab === t ? 'text-primary-500' : 'text-slate-500'">
                        <i :class="{'dashboard': 'fa-chart-pie', 'records': 'fa-list-ul', 'charts': 'fa-chart-line', 'settings': 'fa-gear'}[t]" class="fa-solid text-lg"></i>
                        <span class="capitalize" x-text="t === 'records' ? 'Registros' : t"></span>
                    </button>
                </template>
            </div>
        </div>
    </header>

    <main class="pt-24 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto min-h-screen">
        
        <!-- VIEW: DASHBOARD -->
        <div x-show="activeTab === 'dashboard'" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0">
            
            <!-- Hero Section -->
            <div class="glass-card rounded-3xl p-1 relative overflow-hidden mb-8 group animate-fade-in" :class="currentLevelObj.border.replace('border-left', '')">
                <!-- Dynamic Background -->
                <div class="absolute inset-0 opacity-20 transition-all duration-1000" :class="currentLevelObj.border.replace('border-l-4', '').replace('border-', 'bg-')"></div>
                
                <div class="relative bg-dark-950/80 rounded-[20px] p-6 md:p-10 grid lg:grid-cols-[1fr_1.2fr] gap-8 md:gap-12 items-center backdrop-blur-xl">
                    
                    <!-- Left Side: Bankroll -->
                    <div class="flex flex-col justify-center border-r border-white/5 pr-8">
                        <h2 class="text-sm text-slate-400 font-bold uppercase tracking-widest mb-1">Bankroll Total</h2>
                        <div class="flex items-baseline gap-2 mb-2">
                            <span class="text-5xl md:text-7xl font-mono font-bold text-white tracking-tighter drop-shadow-2xl" x-text="formatMoney(bankroll)"></span>
                            <span class="text-2xl text-slate-600 font-bold">USD</span>
                        </div>
                        <div class="flex items-center gap-2 text-emerald-400/90 font-mono text-lg font-medium bg-emerald-400/10 px-3 py-1 rounded-lg w-fit">
                            <i class="fa-solid fa-arrow-right-arrow-left text-sm opacity-70"></i>
                            <span x-text="formatBRL(bankroll)"></span>
                        </div>
                        <p class="text-xs text-slate-500 mt-2 ml-1" x-text="'Cotação: 1 USD = ' + currencyRate.toFixed(2) + ' BRL'"></p>
                    </div>

                    <!-- Right Side: Level Info (Updated) -->
                    <div @click="showLevels = true" class="relative group cursor-pointer h-full">
                         <!-- Glow Effect -->
                         <div class="absolute inset-0 bg-primary-500/20 rounded-3xl blur-xl opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                         
                         <div class="relative h-full rounded-2xl border transition-all duration-300 overflow-hidden"
                              :class="{
                                 'bg-dark-900/80 border-primary-500/30 shadow-2xl': true,
                                 'group-hover:border-primary-500/50 group-hover:translate-y-[-2px]': true
                              }">
                              
                              <!-- Indicador Lateral Colorido -->
                              <div class="absolute left-0 top-0 bottom-0 w-1.5" :class="currentLevelObj.bg.replace('bg-', 'bg-')"></div>

                              <div class="p-6 pl-8 flex flex-col h-full justify-between">
                                  
                                  <!-- Header: Level Identity -->
                                  <div class="flex items-center justify-between mb-4">
                                      <div class="flex items-center gap-4">
                                          <!-- Ícone Premium -->
                                          <div class="w-14 h-14 rounded-2xl flex items-center justify-center text-2xl shadow-inner border border-white/10" 
                                               :class="currentLevelObj.bg + ' ' + currentLevelObj.color.replace('text-', 'text-white ')">
                                              <i :class="['fa-solid', currentLevelObj.icon]"></i>
                                          </div>
                                          
                                          <div>
                                              <div class="flex items-center gap-2 mb-0.5">
                                                  <h3 class="text-xl font-bold text-white tracking-tight leading-none" x-text="currentLevelObj.name"></h3>
                                                  <span class="bg-primary-500 text-white text-[9px] font-bold px-2 py-0.5 rounded-full uppercase shadow-lg shadow-primary-500/30">Fase Atual</span>
                                              </div>
                                              <p class="text-xs font-mono text-slate-400">
                                                  <span x-text="formatMoney(currentLevelObj.min)"></span> 
                                                  <i class="fa-solid fa-arrow-right mx-1 text-[10px] opacity-50"></i> 
                                                  <span x-text="nextLevelTarget"></span>
                                              </p>
                                          </div>
                                      </div>
                                      
                                      <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-slate-500 group-hover:text-white group-hover:bg-primary-500 transition-all shadow-lg">
                                          <i class="fa-solid fa-chevron-right text-xs"></i>
                                      </div>
                                  </div>

                                  <!-- Progress Bar -->
                                  <div class="mb-5 bg-dark-950/50 p-3 rounded-xl border border-white/5">
                                      <div class="flex justify-between text-[11px] mb-1.5 font-mono">
                                          <span class="text-slate-400">Progresso</span>
                                          <span class="text-primary-400 font-bold" x-text="'Faltam ' + nextLevelGap"></span>
                                      </div>
                                      <div class="w-full bg-slate-800 h-2 rounded-full overflow-hidden shadow-inner">
                                          <div class="h-full bg-gradient-to-r from-primary-600 to-primary-400 relative transition-all duration-1000" :style="'width: ' + levelProgress + '%'">
                                              <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
                                          </div>
                                      </div>
                                  </div>

                                  <!-- Strategy Grid (Premium Layout) -->
                                  <div class="grid grid-cols-3 gap-2 mb-4">
                                      <!-- Suporte -->
                                      <div class="bg-dark-950/40 p-2 rounded-xl border border-white/5 text-center flex flex-col justify-center">
                                          <p class="text-[9px] uppercase font-bold text-slate-500 mb-0.5">Suporte</p>
                                          <p class="text-xs font-mono text-slate-300 font-medium" x-text="currentLevelObj.abiSupport"></p>
                                      </div>
                                      
                                      <!-- Core (Highlighted) -->
                                      <div class="bg-gradient-to-b from-primary-500/10 to-transparent p-2 rounded-xl border border-primary-500/30 text-center relative overflow-hidden">
                                          <div class="absolute top-0 left-0 w-full h-0.5 bg-primary-500"></div>
                                          <p class="text-[9px] uppercase font-bold text-primary-400 mb-0.5 relative z-10">Core</p>
                                          <p class="text-sm font-mono text-white font-bold relative z-10" x-text="currentLevelObj.abiCore"></p>
                                      </div>
                                      
                                      <!-- Shot -->
                                      <div class="bg-dark-950/40 p-2 rounded-xl border border-white/5 text-center flex flex-col justify-center">
                                          <p class="text-[9px] uppercase font-bold text-slate-500 mb-0.5">Shot</p>
                                          <p class="text-xs font-mono text-white font-medium" x-text="currentLevelObj.abiShot"></p>
                                      </div>
                                  </div>
                                  
                                  <!-- Mix de Volume Visual -->
                                  <div class="mb-4">
                                      <div class="flex justify-between items-end mb-1.5 px-1">
                                          <span class="text-[9px] uppercase font-bold text-slate-500">Mix Recomendado</span>
                                      </div>
                                      <div class="flex h-2 w-full rounded-full overflow-hidden bg-slate-800 shadow-inner">
                                          <div class="bg-slate-500 h-full" :style="'width:' + currentLevelObj.pSupport" :title="'Suporte: ' + currentLevelObj.pSupport"></div>
                                          <div class="bg-primary-500 h-full" :style="'width:' + currentLevelObj.pCore" :title="'Core: ' + currentLevelObj.pCore"></div>
                                          <div class="bg-red-500 h-full" :style="'width:' + currentLevelObj.pShot" :title="'Shot: ' + currentLevelObj.pShot"></div>
                                      </div>
                                      <div class="flex justify-between mt-1 text-[9px] text-slate-500 px-1 font-mono">
                                          <span x-text="currentLevelObj.pSupport"></span>
                                          <span x-text="currentLevelObj.pCore" class="text-primary-400 font-bold"></span>
                                          <span x-text="currentLevelObj.pShot"></span>
                                      </div>
                                  </div>

                                  <!-- Focus Footer -->
                                  <div class="bg-white/5 p-3 rounded-xl border border-white/5 flex items-start gap-2">
                                       <i class="fa-solid fa-lightbulb text-yellow-500 text-xs mt-0.5"></i>
                                       <p class="text-[11px] text-slate-300 italic leading-snug" x-text="currentLevelObj.rules"></p>
                                  </div>
                              </div>
                         </div>
                    </div>

                </div>
            </div>

            <!-- Stats Strip (New & Improved) -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <!-- Card 1: Lucro -->
                <div class="glass-card p-5 rounded-2xl relative overflow-hidden group hover:bg-white/5 transition-colors">
                    <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i class="fa-solid fa-sack-dollar text-5xl text-emerald-500"></i>
                    </div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Lucro Total</p>
                    <p class="text-2xl font-mono font-bold tracking-tight" :class="totalProfit >= 0 ? 'text-emerald-400' : 'text-red-400'" x-text="formatMoney(totalProfit)"></p>
                    <div class="mt-2 flex items-center gap-2 text-xs">
                        <span class="bg-emerald-500/10 text-emerald-400 px-2 py-0.5 rounded border border-emerald-500/20 font-mono" x-text="formatMoney(profitPerGame) + '/jogo'"></span>
                    </div>
                </div>

                <!-- Card 2: ROI -->
                <div class="glass-card p-5 rounded-2xl relative overflow-hidden group hover:bg-white/5 transition-colors">
                     <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i class="fa-solid fa-chart-line text-5xl text-primary-500"></i>
                    </div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Rentabilidade</p>
                    <div class="flex items-baseline gap-2">
                        <p class="text-2xl font-mono font-bold text-white" x-text="roi + '%'"></p>
                        <span class="text-xs text-primary-400 font-bold">ROI</span>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">ABI Real: <span class="text-slate-300 font-mono" x-text="formatMoney(abi)"></span></p>
                </div>

                <!-- Card 3: Volume -->
                <div class="glass-card p-5 rounded-2xl relative overflow-hidden group hover:bg-white/5 transition-colors">
                    <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i class="fa-solid fa-layer-group text-5xl text-orange-500"></i>
                    </div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Volume</p>
                    <p class="text-2xl font-mono font-bold text-white" x-text="totalVolume"></p>
                     <div class="mt-2 flex items-center gap-2 text-xs">
                        <span class="text-orange-400 font-bold"><i class="fa-solid fa-fire mr-1"></i> <span x-text="streak"></span> dias seguidos</span>
                    </div>
                </div>

                <!-- Card 4: Chart -->
                <div class="glass-card p-0 rounded-2xl relative overflow-hidden group cursor-pointer hover:border-primary-500/30 transition-colors" @click="activeTab = 'charts'">
                    <div class="absolute inset-0 bg-gradient-to-t from-dark-900 via-transparent to-transparent opacity-50 z-10"></div>
                    <div class="absolute top-4 left-5 z-20">
                         <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Tendência</p>
                    </div>
                    <div class="w-full h-full pt-4">
                        <canvas id="miniChartEl"></canvas>
                    </div>
                </div>
            </div>

            <!-- NOVA SEÇÃO: Acesso Rápido e Histórico Recente -->
            <div class="glass-card rounded-2xl p-6 animate-fade-in">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="fa-solid fa-clock-rotate-left text-slate-400"></i> Últimas Atividades
                    </h3>
                    <button @click="openForm()" class="w-full sm:w-auto bg-primary-600 hover:bg-primary-500 text-white px-5 py-2.5 rounded-xl font-bold text-sm flex items-center justify-center gap-2 shadow-lg shadow-primary-600/20 transition-all hover:scale-105 active:scale-95">
                        <i class="fa-solid fa-plus"></i> Novo Registro
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="text-[10px] uppercase text-slate-500 font-semibold border-b border-white/5">
                            <tr>
                                <th class="py-3 px-2">Data</th>
                                <th class="py-3 px-2">Tipo</th>
                                <th class="py-3 px-2">Local / Jogo</th>
                                <th class="py-3 px-2 text-right">Resultado</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm text-slate-300">
                            <template x-for="s in sessions.slice().sort((a,b) => new Date(b.date + 'T' + (b.startTime || '00:00')) - new Date(a.date + 'T' + (a.startTime || '00:00'))).slice(0, 5)" :key="s.id">
                                <tr class="hover:bg-white/5 transition-colors border-b border-white/5 last:border-0 group cursor-pointer" @click="activeTab = 'records'">
                                    <td class="py-3 px-2 font-mono text-xs text-slate-400" x-text="formatDate(s.date)"></td>
                                    <td class="py-3 px-2 capitalize">
                                        <div class="flex items-center gap-2">
                                            <div class="w-1.5 h-1.5 rounded-full" :class="{'grind':'bg-blue-500','deposit':'bg-emerald-500','withdraw':'bg-red-500'}[s.type]"></div>
                                            <span x-text="s.type"></span>
                                        </div>
                                    </td>
                                    <td class="py-3 px-2">
                                        <span x-text="s.location || '-'"></span>
                                        <span x-show="s.context" class="text-xs text-slate-500 ml-1" x-text="'• ' + s.context"></span>
                                    </td>
                                    <td class="py-3 px-2 text-right font-mono font-bold" :class="s.profit >= 0 ? 'text-emerald-400' : 'text-red-400'" x-text="formatMoney(s.profit)"></td>
                                </tr>
                            </template>
                            <tr x-show="sessions.length === 0">
                                <td colspan="4" class="py-8 text-center text-slate-500 italic">
                                    Nenhuma atividade recente.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4 pt-2 border-t border-white/5 text-center" x-show="sessions.length > 0">
                    <button @click="activeTab = 'records'" class="text-xs font-medium text-slate-500 hover:text-primary-400 transition-colors flex items-center justify-center gap-1 mx-auto">
                        Ver histórico completo <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </div>

        </div>

        <!-- VIEW: REGISTROS (NOVA ABA) -->
        <div x-show="activeTab === 'records'" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0" x-cloak>
            <div class="glass-card rounded-2xl overflow-hidden min-h-[600px] flex flex-col">
                <div class="p-6 border-b border-white/5 bg-dark-900/50 flex justify-between items-center sticky top-0 z-10">
                    <h2 class="text-xl font-bold text-white flex items-center gap-3">
                        <span class="w-10 h-10 rounded-xl bg-primary-600/20 flex items-center justify-center text-primary-500"><i class="fa-solid fa-list-ul"></i></span>
                        Histórico de Sessões
                    </h2>
                    
                    <!-- Filtros e Botão Novo -->
                     <div class="flex gap-2 items-center">
                         <select x-model="filters.month" class="p-2 rounded-lg glass-input text-xs">
                             <option value="all">Todos os Meses</option>
                             <template x-for="m in uniqueMonths"><option :value="m" x-text="m"></option></template>
                         </select>
                         <select x-model="filters.type" class="p-2 rounded-lg glass-input text-xs">
                             <option value="all">Todos os Tipos</option>
                             <option value="grind">Grind</option>
                             <option value="deposit">Depósito</option>
                             <option value="withdraw">Saque</option>
                         </select>
                         <button @click="exportCSV()" class="bg-slate-700 hover:bg-slate-600 text-white p-2 rounded-lg" title="Exportar CSV"><i class="fa-solid fa-file-csv"></i></button>
                         <button @click="openForm()" class="bg-primary-600 hover:bg-primary-500 text-white p-2 rounded-lg font-bold shadow-lg shadow-primary-600/20 transition-all flex items-center gap-1 text-xs">
                            <i class="fa-solid fa-plus"></i> Novo
                        </button>
                     </div>
                </div>

                <div class="flex-grow overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="text-xs uppercase text-slate-500 font-semibold bg-dark-950/50 sticky top-0">
                            <tr>
                                <th class="p-4 w-32">Data</th>
                                <th class="p-4 w-24">Hora</th>
                                <th class="p-4">Evento / Tipo</th>
                                <th class="p-4">Local</th>
                                <th class="p-4 text-right">Investido</th>
                                <th class="p-4 text-right">Retorno</th>
                                <th class="p-4 text-right">Profit</th>
                                <th class="p-4 w-24 text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5 text-sm">
                            <template x-for="s in filteredSessions" :key="s.id">
                                <tr class="hover:bg-white/5 transition-colors group">
                                    <td class="p-4 text-slate-300 font-mono" x-text="formatDate(s.date)"></td>
                                    <td class="p-4 text-slate-500 text-xs font-mono" x-text="s.startTime ? s.startTime + ' - ' + s.endTime : '-'"></td>
                                    <td class="p-4">
                                        <div class="flex flex-col">
                                            <div class="flex items-center gap-2">
                                                <div class="w-2 h-2 rounded-full" :class="{'grind':'bg-blue-500','deposit':'bg-emerald-500','withdraw':'bg-red-500'}[s.type]"></div>
                                                <span class="text-white font-medium capitalize" x-text="s.type"></span>
                                            </div>
                                            <span class="text-xs text-slate-500 ml-4" x-text="s.context || ''"></span>
                                            <span x-show="s.notes" class="text-[10px] text-slate-600 ml-4 italic truncate max-w-[150px]" x-text="s.notes"></span>
                                        </div>
                                    </td>
                                    <td class="p-4 text-slate-400" x-text="s.location || '-'"></td>
                                    <td class="p-4 text-right text-slate-400" x-text="s.invested > 0 ? formatMoney(s.invested) : '-'"></td>
                                    <td class="p-4 text-right text-slate-400" x-text="s.return > 0 ? formatMoney(s.return) : '-'"></td>
                                    <td class="p-4 text-right font-mono font-bold" :class="s.profit >= 0 ? 'text-emerald-400' : 'text-red-400'" x-text="formatMoney(s.profit)"></td>
                                    <td class="p-4 text-center">
                                        <div class="flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button @click="openForm(s)" class="w-8 h-8 rounded-lg bg-slate-800 hover:bg-blue-500 hover:text-white text-slate-400 transition-colors" title="Editar">
                                                <i class="fa-solid fa-pen text-xs"></i>
                                            </button>
                                            <button @click="deleteSession(s.id)" class="w-8 h-8 rounded-lg bg-slate-800 hover:bg-red-500 hover:text-white text-slate-400 transition-colors" title="Excluir">
                                                <i class="fa-solid fa-trash text-xs"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="filteredSessions.length === 0">
                                <td colspan="8" class="p-12 text-center text-slate-500">Nenhum registro encontrado.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VIEW: GRÁFICOS -->
        <div x-show="activeTab === 'charts'" class="space-y-6" x-cloak>
            
             <!-- Top Filters & Summary for Charts -->
             <div class="glass-card p-4 rounded-2xl flex flex-wrap justify-between items-center gap-4">
                <div class="flex gap-2">
                     <select x-model="chartFilters.range" class="p-2 rounded-lg glass-input text-xs font-bold text-white">
                         <option value="all">Todo o Período</option>
                         <option value="year">Este Ano</option>
                         <option value="90d">Últimos 90 Dias</option>
                         <option value="30d">Últimos 30 Dias</option>
                     </select>
                     <select x-model="chartFilters.type" class="p-2 rounded-lg glass-input text-xs font-bold text-white">
                         <option value="all">Todos os Jogos</option>
                         <template x-for="gt in settings.gameTypes"><option :value="gt" x-text="gt"></option></template>
                     </select>
                </div>
                <div class="flex gap-4 text-xs font-mono">
                    <div class="flex flex-col items-end">
                        <span class="text-slate-500">Lucro</span>
                        <span class="font-bold text-emerald-400" x-text="formatMoney(chartStats.profit)"></span>
                    </div>
                    <div class="flex flex-col items-end">
                        <span class="text-slate-500">Volume</span>
                        <span class="font-bold text-white" x-text="chartStats.volume"></span>
                    </div>
                    <div class="flex flex-col items-end">
                        <span class="text-slate-500">ROI</span>
                        <span class="font-bold text-primary-400" x-text="chartStats.roi + '%'"></span>
                    </div>
                </div>
            </div>

            <!-- Main Evolution Chart -->
            <div class="glass-card p-6 rounded-2xl relative h-[400px]">
                <h3 class="text-sm font-bold text-slate-400 mb-4 uppercase tracking-widest">Evolução do Bankroll</h3>
                <div class="h-[320px] w-full">
                     <canvas id="mainChartEl"></canvas>
                </div>
            </div>

            <!-- Detailed Analysis Grid -->
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Monthly Performance -->
                <div class="glass-card p-6 rounded-2xl h-80">
                    <h3 class="text-sm font-bold text-slate-400 mb-4 uppercase tracking-widest">Performance Mensal</h3>
                    <div class="h-60 w-full"><canvas id="monthlyChartEl"></canvas></div>
                </div>

                <!-- ROI Trend (New) -> Using Volume for now as placeholder, ideally separate ROI line -->
                <div class="glass-card p-6 rounded-2xl h-80">
                    <h3 class="text-sm font-bold text-slate-400 mb-4 uppercase tracking-widest">Volume de Jogos</h3>
                    <div class="h-60 w-full"><canvas id="volumeChartEl"></canvas></div>
                </div>
                
                <!-- Profit by Location -->
                <div class="glass-card p-6 rounded-2xl h-80">
                    <h3 class="text-sm font-bold text-slate-400 mb-4 uppercase tracking-widest">Lucro por Site</h3>
                    <div class="h-60 w-full"><canvas id="locationChartEl"></canvas></div>
                </div>

                <!-- Profit by Day of Week -->
                <div class="glass-card p-6 rounded-2xl h-80">
                    <h3 class="text-sm font-bold text-slate-400 mb-4 uppercase tracking-widest">Lucro por Dia da Semana</h3>
                    <div class="h-60 w-full"><canvas id="dowChartEl"></canvas></div>
                </div>
            </div>
            
            <!-- Type Distribution -->
            <div class="glass-card p-6 rounded-2xl">
                 <h3 class="text-sm font-bold text-slate-400 mb-4 uppercase tracking-widest">Distribuição de Volume por Local</h3>
                 <div class="h-60 w-full flex justify-center"><canvas id="typeDistChartEl"></canvas></div>
            </div>
        </div>

        <!-- VIEW: SETTINGS -->
        <div x-show="activeTab === 'settings'" class="space-y-6 max-w-5xl mx-auto" x-cloak>
            <h2 class="text-2xl font-bold text-white mb-4">Ajustes & Dados</h2>
            <div class="grid md:grid-cols-2 gap-6">
                
                <!-- Perfil -->
                <div class="glass-card p-8 rounded-2xl space-y-6">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2 border-b border-white/5 pb-4">
                        <i class="fa-solid fa-user-gear text-slate-400"></i> Perfil
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase">Nome</label>
                            <input type="text" x-model="settings.playerName" @change="saveLocal()" class="w-full p-3 rounded-xl glass-input mt-1">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase">Start Bank ($)</label>
                                <input type="number" step="0.01" x-model.number="settings.initialBankroll" @change="saveLocal()" class="w-full p-3 rounded-xl glass-input mt-1">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-red-400 uppercase">Stop Loss ($)</label>
                                <input type="number" x-model.number="settings.dailyStopLoss" @change="saveLocal()" class="w-full p-3 rounded-xl bg-red-500/10 border border-red-500/20 text-white mt-1">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-blue-400 uppercase">ID Sincronização</label>
                            <input type="text" x-model="settings.syncId" @change="saveLocal(); location.reload()" class="w-full p-3 rounded-xl glass-input mt-1 border-blue-500/30">
                            <p class="text-[10px] text-slate-500 mt-1">Use este mesmo ID em todos os seus dispositivos.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Gestão de Locais e Jogos -->
                <div class="glass-card p-8 rounded-2xl space-y-6">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2 border-b border-white/5 pb-4">
                        <i class="fa-solid fa-list-check text-slate-400"></i> Gerenciar Opções
                    </h3>
                    
                    <!-- Locais -->
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Locais / Sites</label>
                        <div class="flex gap-2 mb-2">
                            <input type="text" x-model="newLocationInput" placeholder="Novo Local..." class="flex-1 p-2 rounded-lg glass-input text-sm" @keydown.enter.prevent="addLocation()">
                            <button @click="addLocation()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 rounded-lg"><i class="fa-solid fa-plus"></i></button>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="loc in settings.locations">
                                <div class="tag-item px-3 py-1 rounded-full text-xs text-slate-300 flex items-center gap-2">
                                    <span x-text="loc"></span>
                                    <button @click="removeLocation(loc)" class="text-slate-500 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Tipos de Jogo -->
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Tipos de Jogo</label>
                        <div class="flex gap-2 mb-2">
                            <input type="text" x-model="newGameTypeInput" placeholder="Novo Tipo..." class="flex-1 p-2 rounded-lg glass-input text-sm" @keydown.enter.prevent="addGameType()">
                            <button @click="addGameType()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 rounded-lg"><i class="fa-solid fa-plus"></i></button>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="gt in settings.gameTypes">
                                <div class="tag-item px-3 py-1 rounded-full text-xs text-slate-300 flex items-center gap-2">
                                    <span x-text="gt"></span>
                                    <button @click="removeGameType(gt)" class="text-slate-500 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Gestão de Arquivos -->
                <div class="md:col-span-2 glass-card p-6 rounded-2xl flex justify-between items-center">
                    <div>
                        <h4 class="text-white font-bold">Backup e Reset</h4>
                        <p class="text-xs text-slate-500">Exporte seus dados ou restaure um backup antigo.</p>
                    </div>
                    <div class="flex gap-3">
                        <button @click="exportData()" class="px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-white text-sm border border-white/5"><i class="fa-solid fa-download mr-1"></i> Backup</button>
                        <label class="px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-white text-sm border border-white/5 cursor-pointer">
                            <i class="fa-solid fa-upload mr-1"></i> Restaurar
                            <input type="file" @change="importData($event)" class="hidden" accept=".json">
                        </label>
                        <button @click="resetAll()" class="px-4 py-2 rounded-lg bg-red-900/20 hover:bg-red-900/40 text-red-400 text-sm border border-red-500/20">Reset</button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- FIREBASE MODULES (Versão Moderna v9) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        // Configuração Nativa fornecida pelo usuário
        const firebaseConfig = {
            apiKey: "AIzaSyB0w_GcC2hmGh4B8tkya3DN-83h-B1ARFE",
            authDomain: "pokermanager-2dd73.firebaseapp.com",
            projectId: "pokermanager-2dd73",
            storageBucket: "pokermanager-2dd73.firebasestorage.app",
            messagingSenderId: "891651566275",
            appId: "1:891651566275:web:8954015ae91e9268a21076",
            measurementId: "G-Z22PMJLVBH"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Expõe funções do Firebase para o Alpine
        window.startCloud = (alpineContext) => {
            signInAnonymously(auth).catch(e => {
                alpineContext.cloudStatus = { connected: false, text: 'Erro Auth', msg: e.message };
            });

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    alpineContext.cloudStatus = { connected: true, text: 'Online', msg: 'Sincronizado' };
                    
                    let unsubscribe = null;

                    const setupListener = () => {
                        if(unsubscribe) unsubscribe();
                        
                        // Use a Sync ID from settings, or fallback to user.uid if empty (though we will provide a default)
                        const docId = alpineContext.settings.syncId || 'default-player';
                        // Path: bankrolls/{docId} - simpler structure
                        const userDocRef = doc(db, 'bankrolls', docId);

                        unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const cloudData = docSnap.data();
                                if (JSON.stringify(cloudData.sessions) !== JSON.stringify(alpineContext.sessions)) {
                                    console.log("Recebendo dados da nuvem...");
                                    alpineContext.isRemoteUpdate = true;
                                    alpineContext.sessions = cloudData.sessions || [];
                                    if(cloudData.settings) alpineContext.settings = {...alpineContext.settings, ...cloudData.settings};
                                    alpineContext.saveLocal(false); 
                                    alpineContext.isRemoteUpdate = false;
                                    // Use event dispatch instead of direct call
                                    window.dispatchEvent(new CustomEvent('external-data-changed'));
                                }
                            } else {
                                alpineContext.pushToCloud();
                            }
                        }, (error) => {
                            console.error("Sync Error:", error);
                            alpineContext.cloudStatus = { connected: false, text: 'Erro Sync', msg: error.message };
                        });
                    }

                    // Initial setup
                    setupListener();

                    // Watch for setting changes to restart listener
                    alpineContext.$watch('settings.syncId', () => {
                        setupListener();
                    });

                    alpineContext.pushToCloud = () => {
                        if(alpineContext.isRemoteUpdate) return;
                        const docId = alpineContext.settings.syncId || 'default-player';
                        const userDocRef = doc(db, 'bankrolls', docId);
                        
                        setDoc(userDocRef, {
                            sessions: JSON.parse(JSON.stringify(alpineContext.sessions)),
                            settings: JSON.parse(JSON.stringify(alpineContext.settings)),
                            lastUpdate: new Date().toISOString()
                        }).catch(e => {
                            console.error("Save Error:", e);
                            alpineContext.cloudStatus = { connected: false, text: 'Erro Salvar', msg: e.message };
                        });
                    };
                }
            });
        };
        
        window.dispatchEvent(new CustomEvent('firebase-ready'));
    </script>
</body>
</html>
